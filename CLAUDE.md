# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 提供在此代码库中工作的指导。

## 项目概述

这是一个动态词汇表 Transformer 语言模型 (TinyGPT) 的最小化演示，具有在线训练功能。项目包含单个 Python 脚本，实现了：

- 带有因果自注意力的小型 GPT-like transformer 架构
- **动态字符级分词**：从词汇表大小0开始，根据训练数据自动扩展
- 用于输入文本和生成样本的交互式 REPL
- 基于用户输入的"训练脉冲"在线学习
- **永久存储系统**：无限容量的训练数据持久化存储
- **文件批量处理**：支持加载txt文件逐行训练

## 架构

### 核心组件

- **TinyGPT**: 主要的 transformer 模型类，支持动态词汇表扩展
- **DynamicTokenizer**: 动态字符级分词器，从空词汇表开始自动学习字符
- **CausalSelfAttention**: 带因果掩码的多头自注意力（支持RoPE位置编码）
- **Block**: 结合注意力和前馈层的 Transformer 块
- **PersistentReplayText**: 永久训练数据存储，支持磁盘持久化和无限容量
- **EMA**: 指数移动平均，支持动态词汇表变化

### 关键配置

- **动态词汇表**：从大小2开始（PAD, UNK），根据输入文本自动扩展
- 上下文长度：256 tokens
- 模型维度：256 嵌入大小，8 注意力头，4 层
- 训练：AdamW 优化器，梯度裁剪，余弦学习率调度
- 存储：混合内存缓存（500KB）+ 磁盘持久化
- 高级功能：RoPE位置编码，权重共享，EMA，top-p采样

## 开发命令

### 运行演示
```bash
python tiny_llm_demo.py
```

### 系统要求
- Python 3.x
- PyTorch
- CUDA 支持可选（自动回退到 CPU）

### 依赖项
安装依赖项：
```bash
pip install -r requirements.txt
```

主要依赖：
- `torch>=2.0.0` - PyTorch 深度学习框架

## 交互式命令

运行后，REPL 支持以下命令：
- **文本输入**: 将文本输入模型进行训练，自动扩展词汇表
- `/load_txt [filename]`: 加载txt文件并逐行训练（推荐）
- `/train [filename]`: 训练模式加载文件（向后兼容）
- `/gen [prefix]`: 生成文本，可选前缀
- `/temp=X.X`: 设置采样温度
- `/topp=X.X`: 设置top-p采样参数
- `/steps=N`: 设置每次脉冲的训练步数
- `/save [filename]`: 保存模型检查点
- `/load [filename]`: 加载模型检查点
- `/stats`: 显示训练数据和词汇表统计信息
- `/quit`: 退出程序

## 模型行为

- **在线学习**: 每次文本输入触发训练脉冲（默认 20 步）
- **动态词汇表**: 自动学习新字符并扩展模型架构
- **生成**: 使用温度采样、top-k和top-p过滤，支持安全的fallback机制
- **永久记忆**: 所有用户输入永久保存到磁盘，支持无限存储
- **采样策略**: 20% 从最近数据采样，80% 从全历史数据采样，平衡即时学习与长期记忆
- **批量处理**: 支持txt文件逐行训练，每行独立处理和生成
- **自动保存**: 程序退出时自动保存模型状态和词汇表
- **数据管理**: `training_data/` 目录存储所有训练数据，`dynamic_vocab.json` 存储词汇表

## 存储架构

- **磁盘存储**: `training_data/training_data.bin` - 所有训练数据
- **动态词汇表**: `dynamic_vocab.json` - 字符到ID的映射表
- **内存缓存**: 最近 500KB 数据的高速缓存
- **检查点**: `model_checkpoint.pt` - 模型权重和优化器状态
- **统计信息**: 通过 `/stats` 命令查看存储使用情况和词汇表状态

## 长期运行

此程序设计用于永久运行：
- 无内存泄漏，自动管理缓存大小
- **动态词汇表扩展**：自动适应新语言和字符
- 所有用户交互都会被记住并用于训练
- 支持中断后恢复，保持训练连续性和词汇表状态
- 从完整历史数据中学习，避免灾难性遗忘
- **多语言支持**：自动学习中文、英文或任何Unicode字符